---
title: "Testing"
author: "Justin L"
date: "4/4/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
library(ggplot2)
library(magrittr)
library(tidyr)
library(dplyr)
library(justinmisc)
library(reshape2)
library(aiR)
library(foreach)
# library(gapminder)
# library(gganimate)
# library(animation)
```

```{r}
#Training data 1

set.seed(6227)
group1.x <- runif(n = 4200)
group1.y <- runif(n = 4200)
group2.x <- runif(n = 4200, min = -1, max = .5)
group2.y <- runif(n = 4200, min = -1, max = .1)

g1 <- cbind(group1.x,group1.y, rep("g1",4200))
colnames(g1) <- c("x","y","group")
g2 <- cbind(group2.x,group2.y, rep("g2",4200))
colnames(g2) <- c("x","y","group")

train <- as.data.frame(rbind(g1,g2))
train <- justinmisc::correct.mode(train,c("num","num","Factor"))
#train$z <- runif(300)
ggplot(train, aes(x,y, color = group)) +
  geom_point()

```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

```{r}

mylayers <- aiRnet(c(2,4,4,2))
# layer1 <- aiRlayer(2,4)
# layer2 <- aiRlayer(4,2)
# mylayers <- list(layer1, layer2)
```


```{r}
# train <- rbind(train, data.frame(x = c(.7, .9, .6, -.7,-.9,-.6),
#                         y = c(-.7,-.6,-.9, .5, .3, .8),
#                         group = c("g2","g2","g2","g1","g1","g1"),
#                         z = c(.1,.2,.4,.5,.7,-.8)))
set.seed(778)
obj <- aiR(data = train,
           input.col = c("x","y"),
                   var.classify = "group",
                   aiRnet = mylayers,
                   cycles = 600,
                   batch.size = 30,  test.rate = 5)

```


```{r}
dat <- na.exclude(gather(obj$Cost, key = "cost.type", value = "cost.value", -cycles))
ggplot(data = dat, aes(x = cycles, y = cost.value, color = cost.type)) +geom_point() + scale_y_log10()
```


```{r}
new <- aiRactivation(data = train[,c("x","y")], aiRnet = obj$aiRnet)
classify_obj <- aiRclassify(data = train[,c("x","y")], factor = levels(train$group), aiRnet = obj$aiRnet)

ggplot(train, aes(x = x, y = y)) +
  geom_point(aes(color = as.factor(classify_obj$classify), alpha = classify_obj$node.max)) 
```

```{r}
aiRrate(data = train, factor = "group", aiRnet = obj$aiRnet)
```

```{r}
inverseSigmoid <- function(x){
  x <- scales::rescale(x, to = c(0.000000001, 0.9999999999))
  log(x/(1-x))
}
visual <- function(aiRactivation, x, y, layer, invert = F){
  #browser()
  data <- aiRactivation[["data"]]
  layer <- aiRactivation[[layer]]
  if(invert){
    layer <- inverseSigmoid(layer)
  }
  ggdat <- cbind(data,layer)
  ggdat <- gather(ggdat, key = "node", value = "activation", -x, -y)
  gg <- ggplot(ggdat, aes_string(x = x, y = y)) +
    geom_point(aes(color = activation)) +
    scale_color_gradient2(low = "orange", mid = "white", high = "blue") +
    facet_wrap(~node)
  return(gg)
}
```



```{r}
visual1 <- cbind(new$data, new$layer1)
visual1 <- gather(visual1, key = "layer",value = "activation", -x, -y)
ggplot(visual1, aes(x = x, y = y)) +
  geom_point(aes(color = activation)) +
  scale_color_gradient2(low = "orange", mid = "white", high = "blue") +
  facet_wrap(~layer)
visual2 <- cbind(new$data, new$layer2)
visual2 <- gather(visual2, key = "layer",value = "activation", -x, -y)
ggplot(visual2, aes(x = x, y = y)) +
  geom_point(aes(color = activation)) +
  scale_color_gradient2(low = "orange", mid = "white", high = "blue") +
  facet_wrap(~layer)
visual3 <- cbind(new$data, new$layer3)
visual3 <- gather(visual3, key = "layer",value = "activation", -x, -y)
ggplot(visual3, aes(x = x, y = y)) +
  geom_point(aes(color = activation)) +
  scale_color_gradient2(low = "orange", mid = "white", high = "blue") +
  facet_wrap(~layer)


```
```{r}
ggplot(as.data.frame(new$data_model), aes(x = x, y = y)) +
  geom_point(aes(color = new$layer2[,1])) +
  scale_color_gradient2(low = "orange", mid = "white", high = "blue")
ggplot(as.data.frame(new$data_model), aes(x = x, y = y)) +
  geom_point(aes(color = new$layer2[,2])) +
  scale_color_gradient2(low = "orange", mid = "white", high = "blue")
```




```{r}
ggplot(as.data.frame(new$data_model), aes(x = x, y = y)) +
  geom_point(aes(color = as.factor(classify_obj$classify), alpha = classify_obj$node.max)) 
```

```{r}
aiRrate(data = train, factor = "group", aiRnet = loss.aiR$aiRnet)
```


```{r}
space.var <- aiRdevelop(data = train, var.classify = "group", aiRnet = mylayers, sample.size = 1, batch.size = 60, steps = 22)
  gg <- ggplot(data = space.var, aes(x = x, y = y, color = classify, alpha = node.max)) +
    geom_point() +
    facet_wrap(~step)
  gg

```

```{r}
train_additional <- data.frame(x = c(runif(n = 600,min = -1,0),runif(n = 600, min = 0, 1)), y = c(runif(n = 600,min = 0,1),runif(n = 600, min = -1, 0)), group = as.factor(rep(c("g3","g4"), each = 600)))
```

```{r}
#build > load all
newaiR <- aiRnet(c(2,100,100,6,4))
aiRnet1 <- newaiR
aiRnet2 <- newaiR
try.test <- rbind(train, train_additional)

system.time(fast <- aiRrun(data = try.test, var.classify = "group",aiRnet = aiRnet1,cycles = 150,sample.size = 1,batch.size = 100,method.propigate = "fast"))
system.time(slow <- aiRrun(data = try.test, var.classify = "group",aiRnet = aiRnet2,cycles = 50,sample.size = 1,batch.size = 100,method.propigate = "slow"))
```

```{r}
iteration <- as.numeric(rownames(fast$loss))
ggplot(data = fast$loss,aes(x = iteration)) +
  geom_point(aes(y = train,color = "train")) +
  geom_point(aes(y = train.error, color = "train.error")) +
  #geom_point(aes(y = test, color = "test")) +
  labs(list(y = "loss"))+
  coord_cartesian(ylim = c(min(loss.aiR$loss[!loss.aiR$loss==0]),max(loss.aiR$loss)))+
  theme(axis.text.x = element_text(angle = 90)) +
  scale_y_log10()
aiRrate(data = try.test, factor = "group", aiRnet = fast$aiRnet)
```

